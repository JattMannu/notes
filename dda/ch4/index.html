<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Global Site Tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-59055167-2"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments)};
          gtag('js', new Date());

          gtag('config', 'UA-59055167-2');
        </script>

        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://notes.shichao.io/dda/ch4/">
        <link rel="shortcut icon" href="../../toki_32.png">
        

	<title>Chatper 4. Encoding and Evolution - Shichao's Notes</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,400italic,500,600" rel="stylesheet">
        <link href="../../custom.css" rel="stylesheet">
        <link href="../../friendly.css" rel="stylesheet">
        <link href="../../theme.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Shichao's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">APUE <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../apue/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch1/">Chapter 1. UNIX System Overview</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch2/">Chapter 2. UNIX Standardization and Implementations</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch3/">Chapter 3. File I/O</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch4/">Chapter 4. Files and Directories</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch5/">Chapter 5. Standard I/O Library</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch6/">Chapter 6. System Data Files and Information</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch7/">Chapter 7. Process Environment</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch8/">Chapter 8. Process Control</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch9/">Chapter 9. Process Relationships</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch10/">Chapter 10. Signals</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch11/">Chapter 11. Threads</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch12/">Chapter 12. Thread Control</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch13/">Chapter 13. Daemon Processes</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch14/">Chapter 14. Advanced I/O</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch15/">Chapter 15. Interprocess Communication</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch16/">Chapter 16. Network IPC: Sockets</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch17/">Chapter 17. Advanced IPC</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">LKD <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../lkd/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch1/">Chapter 1. Introduction to the Linux Kernel</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch2/">Chapter 2. Getting Started with the Kernel</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch3/">Chapter 3. Process Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch4/">Chapter 4. Process Scheduling</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch5/">Chapter 5. System Calls</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch6/">Chapter 6. Kernel Data Structures</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch7/">Chapter 7. Interrupts and Interrupt Handlers</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch8/">Chapter 8. Bottom Halves and Deferring Work</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch9/">Chapter 9. An Introduction to Kernel Synchronization</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch10/">Chapter 10. Kernel Synchronization Methods</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch11/">Chapter 11. Timers and Time Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch12/">Chapter 12. Memory Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch13/">Chapter 13. The Virtual Filesystem</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch14/">Chapter 14. The Block I/O Layer</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch15/">Chapter 15. The Process Address Space</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch16/">Chapter 16. The Page Cache and Page Writeback</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UNP <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../unp/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch1/">Chapter 1. Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch2/">Chapter 2. The Transport Layer: TCP, UDP, and SCTP</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch3/">Chapter 3. Sockets Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch4/">Chapter 4. Elementary TCP Sockets</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch5/">Chapter 5. TCP Client/Server Example</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch6/">Chapter 6. I/O Multiplexing: The select and poll Functions</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch7/">Chapter 7. Socket Options</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch8/">Chapter 8. Elementary UDP Sockets</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">TCPv1 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../tcpv1/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch1/">Chapter 1. Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch2/">Chapter 2. The Internet Address Architecture</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch3/">Chapter 3. Link Layer</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch4/">Chapter 4. ARP: Address Resolution Protocol</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch5/">Chapter 5. The Internet Protocol (IP)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch6/">Chapter 6. System Configuration: DHCP and Autoconfiguration</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch7/">Chapter 7. Firewalls and Network Address Translation (NAT)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch8/">Chapter 8. ICMPv4 and ICMPv6: Internet Control Message Protocol</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch9/">Chapter 9. Broadcasting and Local Multicasting (IGMP and MLD)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch10/">Chapter 10. User Datagram Protocol (UDP) and IP Fragmentation</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch11/">Chapter 11. Name Resolution and the Domain Name System (DNS)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch12/">Chapter 12. TCP: The Transmission Control Protocol (Preliminaries)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch13/">Chapter 13. TCP Connection Management</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch14/">Chapter 14. TCP Timeout and Retransmission</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch15/">Chapter 15. TCP Data Flow and Window Management</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch16/">Chapter 16. TCP Congestion Control</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch17/">Chapter 17. TCP Keepalive</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch18/">Chapter 18. Security: EAP, IPsec, TLS, DNSSEC, and DKIM</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/headers/">Headers</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">GOPL <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../gopl/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch1/">Chapter 1. Tutorial</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch2/">Chapter 2. Program Structure</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch3/">Chapter 3. Basic Data Types</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch4/">Chapter 4. Composite Types</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch5/">Chapter 5. Functions</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch6/">Chapter 6. Methods</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch7/">Chapter 7. Interfaces</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch8/">Chapter 8. Goroutines and Channels</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch9/">Chapter 9. Concurrency with Shared Variables</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch10/">Chapter 10. Packages and the Go Tool</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch11/">Chapter 11. Testing</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch12/">Chapter 12. Reflection</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">CSN <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../csn/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../csn/part1/">Part 1: Language</a>
                        </li>
                      
                        <li>
                            <a href="../../csn/part2/">Part 2: Advanced</a>
                        </li>
                      
                    </ul>
                </li>
            <li>
                    <a href="../../toc/">TOC</a>
                </li>
            </ul>
            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    
                        <a href="https://github.com/shichao-an/notes/blob/master/docs/dda/ch4.md">
                    
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#chatper-4-encoding-and-evolution">Chatper 4. Encoding and Evolution</a></li>
        
    
        <li class="main "><a href="#formats-for-encoding-data">Formats for Encoding Data</a></li>
        
            <li><a href="#language-specific-formats">Language-Specific Formats</a></li>
        
            <li><a href="#json-xml-and-binary-variants">JSON, XML, and Binary Variants</a></li>
        
            <li><a href="#thrift-and-protocol-buffers">Thrift and Protocol Buffers</a></li>
        
            <li><a href="#avro">Avro</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">
              

<h3 id="chatper-4-encoding-and-evolution"><strong>Chatper 4. Encoding and Evolution</strong><a class="headerlink" href="#chatper-4-encoding-and-evolution" title="Permanent link">&para;</a></h3>
<p>Applications change over time:</p>
<ul>
<li>Features are added or modified as new products are launched,</li>
<li>User requirements become better understood, or,</li>
<li>Business circumstances change.</li>
</ul>
<p><a href="../ch1/">Chapter 1</a> introduced the idea of evolvability: we should aim to build systems that make it easy to adapt to change (see <a href="../ch1/#evolvability-making-change-easy">Evolvability: Making Change Easy</a>).</p>
<p>[p111]</p>
<p>A change to an application's features also requires a change to data that it stores. The data models in <a href="../ch2/">Chapter 2</a> have different ways of coping with such change:</p>
<ul>
<li>Relational databases generally assume that all data in the database conforms to one schema: although that schema can be changed (through schema migrations; i.e., <code>ALTER</code> statements), there is exactly one schema in force at any one point in time.</li>
<li>By contrast, schema-on-read ("schemaless") databases don't enforce a schema, so the database can contain a mixture of older and newer data formats written at different times (see <a href="../ch2/#schema-flexibility-in-the-document-model">Schema flexibility in the document model</a>).</li>
</ul>
<p>When a data format or schema changes, a corresponding change to application code often needs to happen However, in a large application, code changes often cannot happen instantaneously:</p>
<ul>
<li>With server-side applications, you needs to perform a <a href="https://en.wikipedia.org/wiki/Rolling_release"><em>rolling upgrade</em></a> (also known as a <em>staged rollout</em>), deploying the new version to a few nodes at a time, checking whether the new version is running smoothly, and gradually working your way through all the nodes. This allows new versions to be deployed without service downtime, and thus encourages more frequent releases and better evolvability.</li>
<li>With client-side applications you're at the mercy of the user, who may not install the update for some time.</li>
</ul>
<p>This means that old and new versions of the code, and old and new data formats, may potentially all coexist in the system at the same time. In order for the system to continue running smoothly, we need to maintain compatibility in both directions:</p>
<ul>
<li><strong>Backward compatibility</strong>. Newer code can read data that was written by older code. This is normally not hard to achieve: as author of the newer code, you know the format of data written by older code, and so you can explicitly handle it
(if necessary by simply keeping the old code to read the old data).</li>
<li><strong>Forward compatibility</strong>. Older code can read data that was written by newer code. This can be trickier, because it requires older code to ignore additions made by a newer version of the code</li>
</ul>
<p>This chapter discusses the following topics:</p>
<ul>
<li>Several formats for encoding data, including JSON, XML, Protocol Buffers, Thrift, and Avro</li>
<li>In particular, how those formats handle schema changes and how they support systems where old and new data and code need to coexist.</li>
<li>How those formats are used for data storage and for communication: in web services, Representational State Transfer (REST), and remote procedure calls (RPC), as well as message-passing systems such as actors and message queues.</li>
</ul>
<h3 id="formats-for-encoding-data">Formats for Encoding Data<a class="headerlink" href="#formats-for-encoding-data" title="Permanent link">&para;</a></h3>
<p>Programs usually work with data in two different representations:</p>
<ol>
<li>In memory, data is kept in data structures such as objects, structs, lists, arrays, hash tables and trees, optimized for efficient access and manipulation by the CPU (typically using pointers).</li>
<li>When you want to write data to a file or send it over the network, you have to encode it as some kind of self-contained sequence of bytes (for example, a JSON document). Since a pointer wouldn't make sense to any other process, this sequence-of-bytes representation looks quite different from the data structures that are normally used in memory, with the exception of some special cases, such as certain <a href="https://en.wikipedia.org/wiki/Memory-mapped_file">memory-mapped files</a> or when operating directly on compressed data (as described in <a href="../ch3/#column-compression">Column Compression</a> in Chapter 3).</li>
</ol>
<p>Thus, we need translation between the two representations:</p>
<ul>
<li>The translation from the in-memory representation to a byte sequence is called <strong>encoding</strong> (also known as <a href="https://en.wikipedia.org/wiki/Serialization"><em>serialization</em></a> or <a href="https://en.wikipedia.org/wiki/Marshalling_(computer_science)"><em>marshalling</em></a>).</li>
<li>The reverse is called <strong>decoding</strong> (<em>parsing</em>, <em>deserialization</em>, <a href="https://en.wikipedia.org/wiki/Unmarshalling"><em>unmarshalling</em></a>).</li>
</ul>
<p>The term <a href="https://en.wikipedia.org/wiki/Serializability"><em>serialization</em></a> is also used in the context of <a href="https://en.wikipedia.org/wiki/Database_transaction">transactions</a> (see <a href="ch7.md">Chapter 7</a>), with a completely different meaning. We'll stick with <em>encoding</em> in this book.</p>
<h4 id="language-specific-formats">Language-Specific Formats<a class="headerlink" href="#language-specific-formats" title="Permanent link">&para;</a></h4>
<p>Many programming languages come with built-in support for encoding in-memory
objects into byte sequences. For example:</p>
<ul>
<li>Java has <a href="https://docs.oracle.com/javase/8/docs/api/java/io/Serializable.html"><code>java.io.Serializable</code></a> (see <a href="https://docs.oracle.com/javase/8/docs/platform/serialization/spec/serialTOC.html">Java Object Serialization Specification</a>)</li>
<li>Ruby has <a href="https://ruby-doc.org/core-2.5.0/Marshal.html"><code>Marshal</code></a></li>
<li>Python has <a href="https://docs.python.org/3/library/pickle.html"><code>pickle</code></a></li>
</ul>
<p>Many third-party libraries also exist, such as <a href="https://github.com/EsotericSoftware/kryo">Kryo</a> for Java.</p>
<p>These encoding libraries are very convenient, because they allow in-memory objects to be saved and restored with minimal additional code, but they also have a number of problems:</p>
<ul>
<li><strong>Language-Specific</strong>. The encoding is often tied to a particular programming language, and reading the data in another language is very difficult.</li>
<li><strong>Security</strong>. In order to restore data in the same object types, the decoding process needs to be able to instantiate arbitrary classes. This is a source of security problems: if an attacker can get your application to decode an arbitrary byte sequence, they can instantiate arbitrary classes, which in turn often allows them to do terrible things such as remotely executing arbitrary code.</li>
<li><strong>Versioning</strong>. As they are intended for quick and easy encoding of data, they often neglect the inconvenient problems of forward and backward compatibility.</li>
<li><strong>Efficiency</strong>. The efficiency such as the CPU time taken to encode or decode, and the size of the encoded structure, is also often an afterthought. For example, Java's built-in serialization is notorious for its bad performance and bloated encoding.</li>
</ul>
<p>For these reasons it's generally a bad idea to use your language’s built-in encoding for anything other than very transient purposes.</p>
<h4 id="json-xml-and-binary-variants">JSON, XML, and Binary Variants<a class="headerlink" href="#json-xml-and-binary-variants" title="Permanent link">&para;</a></h4>
<p>JSON and XML are the widely known and supported standardized encodings widely supported, XML is often criticized for being too verbose and unnecessarily complicated. JSON's popularity is mainly due to its built-in support in web browsers (by virtue of being a subset of JavaScript) and simplicity relative to XML. CSV is another popular language-independent format, albeit less powerful.</p>
<p>As textual formats, JSON, XML, and CSV also have some subtle problems:</p>
<ul>
<li>Ambiguity in numbers. In XML and CSV, you cannot distinguish between a number and a string that happens to consist of digits (except by referring to an external schema). JSON distinguishes strings and numbers, but it doesn't distinguish integers and floating-point numbers, and it doesn't specify a precision.<ul>
<li>This is a problem when dealing with large numbers; for example, integers greater than 2<sup>53</sup> cannot be exactly represented in an <a href="https://en.wikipedia.org/wiki/Double-precision_floating-point_format">IEEE 754 double-precision floating-point</a> number, so such numbers become inaccurate when parsed in a language that uses floating-point numbers (such as JavaScript). Such an example occurs on Twitter, which uses a 64-bit number to identify each tweet. The JSON returned by Twitter's API includes tweet IDs twice, once as a JSON number and once as a decimal string, to work around the fact that the numbers are not correctly parsed by JavaScript applications.</li>
</ul>
</li>
<li>Lacking binary strings support. JSON and XML have good support for Unicode character strings (i.e., human-readable text), but they don't support binary strings (sequences of bytes without a character encoding).<ul>
<li>Binary strings are a useful feature, so people get around this limitation by encoding the binary data as text using <a href="https://en.wikipedia.org/wiki/Base64">Base64</a>. The schema is then used to indicate that the value should be interpreted as Base64-encoded. This works, but it’s somewhat hacky and increases the data size by 33%.</li>
</ul>
</li>
<li>There is optional schema support for both XML (see <a href="https://www.w3.org/XML/Schema">XML Schema</a>) and JSON (see <a href="http://json-schema.org/">JSON Schema</a>). Use of XML schemas is fairly widespread, but many JSON-based tools don't bother using schemas. Since the correct interpretation of data (such as numbers and binary strings) depends on the schema, applications that don't use XML/JSON schemas need to potentially hardcode the appropriate encoding/decoding logic instead.</li>
<li>CSV does not have any schema, so it is up to the application to define the meaning of each row and column. If an application change adds a new row or column, you have to handle that change manually.</li>
</ul>
<p>Despite these flaws, JSON, XML, and CSV are good enough for many purposes. It's likely that they will remain popular, especially as data interchange formats (i.e., for sending data from one organization to another).</p>
<h5 id="binary-encoding"><strong>Binary encoding</strong><a class="headerlink" href="#binary-encoding" title="Permanent link">&para;</a></h5>
<p>For data that is used only internally within your organization, you could choose a format that is more compact or faster to parse.</p>
<p>Although JSON is less verbose than XML, they both still use a lot of space compared to binary formats. This led to the development of a profusion of binary encodings:</p>
<ul>
<li>For JSON: <a href="https://en.wikipedia.org/wiki/MessagePack">MessagePack</a>, <a href="https://en.wikipedia.org/wiki/BSON">BSON</a>, BJSON, <a href="https://en.wikipedia.org/wiki/UBJSON">UBJSON</a>, BISON, and <a href="https://en.wikipedia.org/wiki/Smile_(data_interchange_format)">Smile</a></li>
<li>For XML: <a href="https://en.wikipedia.org/wiki/WBXML">WBXML</a> and <a href="https://en.wikipedia.org/wiki/Fast_Infoset">Fast Infoset</a> (FI)</li>
</ul>
<p>These formats have been adopted in various niches, but none of them are as widely adopted as the textual versions of JSON and XML.</p>
<p>Some of these formats extend the set of datatypes (e.g., distinguishing integers and floating-point numbers, or adding support for binary strings), but otherwise they keep the JSON/XML data model unchanged. In particular, since they don't prescribe a schema, they need to include all the object field names within the encoded data.</p>
<p>For example, in a binary encoding of the JSON document below, they will need to include the strings <code>userName</code>, <code>favoriteNumber</code>, and <code>interests</code> somewhere.</p>
<p><small>Example 4-1</small></p>
<div class="codehilite"><pre><span class="p">{</span>
    <span class="nt">&quot;userName&quot;</span><span class="p">:</span> <span class="s2">&quot;Martin&quot;</span><span class="p">,</span>
    <span class="nt">&quot;favoriteNumber&quot;</span><span class="p">:</span> <span class="mi">1337</span><span class="p">,</span>
    <span class="nt">&quot;interests&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;daydreaming&quot;</span><span class="p">,</span> <span class="s2">&quot;hacking&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>The following figure shows the byte sequence that you get if you encode the JSON document in the above example with MessagePack.</p>
<p><a href="../figure_4-1.png" title="Figure 4-1. Example record (Example 4-1) encoded using MessagePack."><img alt="Figure 4-1. Example record (Example 4-1) encoded using MessagePack." src="../figure_4-1_600.png" /></a></p>
<p>The first few bytes are as follows:</p>
<ol>
<li>The first byte, <code>0x83</code>, indicates that what follows is an object (top four bits = <code>0x80</code>) with three fields (bottom four bits = <code>0x03</code>). (If an object has more than 15 fields, so that the number of fields doesn't fit in four bits, it then gets a different type indicator, and the number of fields is encoded in two or four bytes.)</li>
<li>The second byte, <code>0xa8</code>, indicates that what follows is a string (top four bits = <code>0xa0</code>) that is eight bytes long (bottom four bits = <code>0x08</code>).</li>
<li>The next eight bytes are the field name <code>userName</code> in ASCII. Since the length was indicated previously, there's no need for any marker to tell us where the string ends (or any escaping).</li>
<li>The next seven bytes encode the six-letter string value <code>Martin</code> with a prefix <code>0xa6</code>, and so on.</li>
</ol>
<p>The binary encoding is 66 bytes long, which is only a little less than the 81 bytes taken by the textual JSON encoding (with whitespace removed). All the binary encodings of JSON are similar in this regard. It's not clear whether such a small space reduction (and perhaps a speedup in parsing) is worth the loss of human-readability.</p>
<h4 id="thrift-and-protocol-buffers">Thrift and Protocol Buffers<a class="headerlink" href="#thrift-and-protocol-buffers" title="Permanent link">&para;</a></h4>
<p><a href="https://en.wikipedia.org/wiki/Apache_Thrift">Apache Thrift</a> and <a href="https://en.wikipedia.org/wiki/Protocol_Buffers">Protocol Buffers</a> (protobuf) are binary encoding libraries that are based on the same principle. Protocol Buffers was originally developed at Google, Thrift was originally developed at Facebook, and both were made open source in 2007–08.</p>
<p>Both Thrift and Protocol Buffers require a schema for any data that is encoded. To encode the data in Example 4-1 in Thrift, you would describe the schema in the Thrift <a href="https://en.wikipedia.org/wiki/Interface_description_language">interface definition language</a> (IDL) like this:</p>
<div class="codehilite"><pre><span class="kd">struct</span><span class="w"> </span><span class="nc">Person</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="k">required</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">userName</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="n">favoriteNumber</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kt">list</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span><span class="w"> </span><span class="n">interests</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>The equivalent schema definition for Protocol Buffers looks very similar:</p>
<div class="codehilite"><pre><span class="kd">message</span> <span class="nc">Person</span> <span class="p">{</span>
    <span class="k">required</span> <span class="kt">string</span> <span class="na">user_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">optional</span> <span class="kt">int64</span> <span class="na">favorite_number</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">repeated</span> <span class="kt">string</span> <span class="na">interests</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Thrift and Protocol Buffers each come with a code generation tool that takes a schema definition like the ones shown above, and produces classes that implement the schema in various programming languages. Your application code can call this generated code to encode or decode records of the schema.</p>
<p>Thrift has two different binary encoding formats: <a href="https://github.com/apache/thrift/blob/master/doc/specs/thrift-binary-protocol.md"><em>BinaryProtocol</em></a> and <a href="https://github.com/apache/thrift/blob/master/doc/specs/thrift-compact-protocol.md"><em>CompactProtocol</em></a>.</p>
<p>Encoding Example 4-1 in BinaryProtocol takes 59 bytes, as shown in the following figure:</p>
<p><a href="../figure_4-2.png" title="Figure 4-2. Example record encoded using Thrift’s BinaryProtocol."><img alt="Figure 4-2. Example record encoded using Thrift’s BinaryProtocol." src="../figure_4-2_600.png" /></a></p>
<p>Similarly to <a href="../figure_4-1.png">Figure 4-1</a>, each field has:</p>
<ul>
<li>A type annotation and,</li>
<li>A length indication, when required (e.g.length of a string, number of items in a list).</li>
</ul>
<p>The strings that appear in the data ("Martin", "daydreaming", "hacking") are also encoded as ASCII (or rather, UTF-8), similar to before.</p>
<p>The big difference compared to Figure 4-1 is that there are no field names (<code>userName</code>, <code>favoriteNumber</code>, <code>interests</code>). Instead, the encoded data contains <em>field tags</em>, which are numbers (<code>1</code>, <code>2</code>, and <code>3</code>). Those are the numbers that appear in the schema definition. Field tags are like aliases for fields.</p>
<p>The Thrift CompactProtocol encoding is semantically equivalent to BinaryProtocol, but it packs the same information into only 34 bytes, as shown in the figure below.</p>
<p><a href="../figure_4-3.png" title="Figure 4-3. Example record encoded using Thrift’s CompactProtocol."><img alt="Figure 4-3. Example record encoded using Thrift’s CompactProtocol." src="../figure_4-3_600.png" /></a></p>
<p>The size is much smaller because:</p>
<ul>
<li>It packs the field type and tag number into a single byte.</li>
<li>It uses variable-length integers.</li>
</ul>
<p>Rather than using a full eight bytes for the number 1337, it is encoded in two bytes, with the top bit of each byte used to indicate whether there are still more bytes to come. This means numbers between –64 and 63 are encoded in one byte, numbers between –8192 and 8191 are encoded in two bytes, etc. Bigger numbers use more bytes</p>
<p>Finally, Protocol Buffers (which has only one binary encoding format) encodes the same data as shown in the figure below. It does the bit packing slightly differently, but is otherwise very similar to Thrift's CompactProtocol. Protocol Buffers fits the same record in 33 bytes.</p>
<p><a href="../figure_4-4.png" title="Figure 4-4. Example record encoded using Protocol Buffers."><img alt="Figure 4-4. Example record encoded using Protocol Buffers." src="../figure_4-4_600.png" /></a></p>
<p>Note in the schemas shown earlier, each field was marked either <code>required</code> or <code>optional</code>, but this makes no difference to how the field is encoded (nothing in the binary data indicates whether a field was required). The difference is simply that required enables a runtime check that fails if the field is not set, which can be useful for catching bugs.</p>
<h5 id="field-tags-and-schema-evolution"><strong>Field tags and schema evolution</strong><a class="headerlink" href="#field-tags-and-schema-evolution" title="Permanent link">&para;</a></h5>
<p>Schemas inevitably need to change over time. This is called <a href="https://en.wikipedia.org/wiki/Schema_evolution"><em>schema evolution</em></a>. How do Thrift and Protocol Buffers handle schema changes while keeping backward and forward compatibility?</p>
<p>An encoded record is just the concatenation of its encoded fields. Each field is identified by its tag number (the numbers <code>1</code>, <code>2</code>, <code>3</code> in the sample schemas) and annotated with a datatype. If a field value is not set, it is simply omitted from the encoded record. From this you can see that field tags are critical to the meaning of the encoded data. You can change the name of a field in the schema, since the encoded data never refers to field names, but you cannot change a field's tag, since that would make all existing encoded data invalid.</p>
<ul>
<li>Forward compatibility (old code can read data written by new code). You can add new fields to the schema, provided that you give each field a new tag number. If old code (which doesn't know about the new tag numbers you added) tries to read data written by new code, it can simply ignore a new field with a tag number it doesn't recognize. The datatype annotation allows the parser to determine how many bytes it needs to skip.</li>
<li>Backward compatibility (new code can can read data written by old code). As long as each field has a unique tag number, new code can always read old data, because the tag numbers still have the same meaning. The only detail is that if you add a new field, you cannot make it required.  If you were to add a field and make it required, that check would fail if new code read data written by old code, because the old code will not have written the new field that you added. <u>Therefore, to maintain backward compatibility, every field you add after the initial deployment of the schema must be optional or have a default value.</u></li>
</ul>
<p>Removing a field is just like adding a field, with backward and forward compatibility concerns reversed:</p>
<ul>
<li>You can only remove a field that is optional (a required field can never be removed);</li>
<li>You can never use the same tag number again (because you may still have data written somewhere that includes the old tag number, and that field must be ignored by new code).</li>
</ul>
<h5 id="datatypes-and-schema-evolution"><strong>Datatypes and schema evolution</strong><a class="headerlink" href="#datatypes-and-schema-evolution" title="Permanent link">&para;</a></h5>
<p>Changing the datatype of a field may be possible, but there is a risk that values will lose precision or get truncated.</p>
<p>For example, say you change a 32-bit integer into a 64-bit integer:</p>
<ul>
<li>New code can easily read data written by old code, because the parser can fill in any missing bits with zeros.</li>
<li>However, if old code reads data written by new code, the old code is still using a 32-bit variable to hold the value. If the decoded 64-bit value won't fit in 32 bits, it will be truncated.</li>
</ul>
<p>Protocol Buffers does not have a list or array datatype, but instead has a <code>repeated</code> marker for fields (which is a third option alongside <code>required</code> and <code>optional</code>). As you can see in <a href="../figure_4-4.png">Figure 4-4</a>, the encoding of a repeated field is just what it says on the tin: the same field tag simply appears multiple times in the record. This has the nice effect that it's okay to change an <code>optional</code> (single-valued) field into a <code>repeated</code> (multi-valued) field:</p>
<ul>
<li>New code reading old data sees a list with zero or one elements (depending on whether the field was present);</li>
<li>Old code reading new data sees only the last element of the list.</li>
</ul>
<p>Thrift has a dedicated list datatype, which is parameterized with the datatype of the list elements. This does not allow the same evolution from single-valued to multi-valued as Protocol Buffers does, but it has the advantage of supporting nested lists.</p>
<h4 id="avro">Avro<a class="headerlink" href="#avro" title="Permanent link">&para;</a></h4>
            </div>
        </div>

        <footer class="col-md-12">
            
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../custom.js"></script>
    </body>
</html>