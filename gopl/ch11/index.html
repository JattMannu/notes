<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://notes.shichao.io/gopl/ch11/">
        <link rel="shortcut icon" href="../../toki_32.png">
        

	<title>Chapter 11. Testing - Shichao's Notes</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,400italic,500,600" rel="stylesheet">
        <link href="../../custom.css" rel="stylesheet">
        <link href="../../friendly.css" rel="stylesheet">
        <link href="../../theme.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Shichao's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">APUE <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../apue/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch1/">Chapter 1. UNIX System Overview</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch2/">Chapter 2. UNIX Standardization and Implementations</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch3/">Chapter 3. File I/O</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch4/">Chapter 4. Files and Directories</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch5/">Chapter 5. Standard I/O Library</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch6/">Chapter 6. System Data Files and Information</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch7/">Chapter 7. Process Environment</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch8/">Chapter 8. Process Control</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch9/">Chapter 9. Process Relationships</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch10/">Chapter 10. Signals</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch11/">Chapter 11. Threads</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch12/">Chapter 12. Thread Control</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch13/">Chapter 13. Daemon Processes</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch14/">Chapter 14. Advanced I/O</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch15/">Chapter 15. Interprocess Communication</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch16/">Chapter 16. Network IPC: Sockets</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch17/">Chapter 17. Advanced IPC</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">LKD <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../lkd/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch1/">Chapter 1. Introduction to the Linux Kernel</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch2/">Chapter 2. Getting Started with the Kernel</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch3/">Chapter 3. Process Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch4/">Chapter 4. Process Scheduling</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch5/">Chapter 5. System Calls</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch6/">Chapter 6. Kernel Data Structures</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch7/">Chapter 7. Interrupts and Interrupt Handlers</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch8/">Chapter 8. Bottom Halves and Deferring Work</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch9/">Chapter 9. An Introduction to Kernel Synchronization</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch10/">Chapter 10. Kernel Synchronization Methods</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch11/">Chapter 11. Timers and Time Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch12/">Chapter 12. Memory Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch13/">Chapter 13. The Virtual Filesystem</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch14/">Chapter 14. The Block I/O Layer</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch15/">Chapter 15. The Process Address Space</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch16/">Chapter 16. The Page Cache and Page Writeback</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UNP <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../unp/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch1/">Chapter 1. Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch2/">Chapter 2. The Transport Layer: TCP, UDP, and SCTP</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch3/">Chapter 3. Sockets Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch4/">Chapter 4. Elementary TCP Sockets</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch5/">Chapter 5. TCP Client/Server Example</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch6/">Chapter 6. I/O Multiplexing: The select and poll Functions</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch7/">Chapter 7. Socket Options</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch8/">Chapter 8. Elementary UDP Sockets</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">TCPv1 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../tcpv1/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch1/">Chapter 1. Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch2/">Chapter 2. The Internet Address Architecture</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch3/">Chapter 3. Link Layer</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch4/">Chapter 4. ARP: Address Resolution Protocol</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch5/">Chapter 5. The Internet Protocol (IP)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch6/">Chapter 6. System Configuration: DHCP and Autoconfiguration</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch7/">Chapter 7. Firewalls and Network Address Translation (NAT)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch8/">Chapter 8. ICMPv4 and ICMPv6: Internet Control Message Protocol</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch9/">Chapter 9. Broadcasting and Local Multicasting (IGMP and MLD)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch10/">Chapter 10. User Datagram Protocol (UDP) and IP Fragmentation</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch11/">Chapter 11. Name Resolution and the Domain Name System (DNS)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch12/">Chapter 12. TCP: The Transmission Control Protocol (Preliminaries)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch13/">Chapter 13. TCP Connection Management</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch14/">Chapter 14. TCP Timeout and Retransmission</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch15/">Chapter 15. TCP Data Flow and Window Management</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch16/">Chapter 16. TCP Congestion Control</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch17/">Chapter 17. TCP Keepalive</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch18/">Chapter 18. Security: EAP, IPsec, TLS, DNSSEC, and DKIM</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/headers/">Headers</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">GOPL <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../ch1/">Chapter 1. Tutorial</a>
                        </li>
                      
                        <li>
                            <a href="../ch2/">Chapter 2. Program Structure</a>
                        </li>
                      
                        <li>
                            <a href="../ch3/">Chapter 3. Basic Data Types</a>
                        </li>
                      
                        <li>
                            <a href="../ch4/">Chapter 4. Composite Types</a>
                        </li>
                      
                        <li>
                            <a href="../ch5/">Chapter 5. Functions</a>
                        </li>
                      
                        <li>
                            <a href="../ch6/">Chapter 6. Methods</a>
                        </li>
                      
                        <li>
                            <a href="../ch7/">Chapter 7. Interfaces</a>
                        </li>
                      
                        <li>
                            <a href="../ch8/">Chapter 8. Goroutines and Channels</a>
                        </li>
                      
                        <li>
                            <a href="../ch9/">Chapter 9. Concurrency with Shared Variables</a>
                        </li>
                      
                        <li>
                            <a href="../ch10/">Chapter 10. Packages and the Go Tool</a>
                        </li>
                      
                        <li class="active">
                            <a href="./">Chapter 11. Testing</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">CSN <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../csn/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../csn/part1/">Part 1: Language</a>
                        </li>
                      
                        <li>
                            <a href="../../csn/part2/">Part 2: Advanced</a>
                        </li>
                      
                    </ul>
                </li>
            <li>
                    <a href="../../toc/">TOC</a>
                </li>
            </ul>
            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    
                        <a href="https://github.com/shichao-an/notes/blob/master/docs/gopl/ch11.md">
                    
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#chapter-11-testing">Chapter 11. Testing</a></li>
        
    
        <li class="main "><a href="#the-go-test-tool">The go test Tool</a></li>
        
    
        <li class="main "><a href="#test-functions">Test Functions</a></li>
        
            <li><a href="#randomized-testing">Randomized Testing</a></li>
        
            <li><a href="#testing-a-command">Testing a Command</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">
              

<h3 id="chapter-11-testing"><strong>Chapter 11. Testing</strong><a class="headerlink" href="#chapter-11-testing" title="Permanent link">&para;</a></h3>
<p>[p301]</p>
<p>Programs today are far larger and more complex than in <a href="https://en.wikipedia.org/wiki/Maurice_Wilkes">Maurice Wilkes</a>'s time, and a great deal of effort has been spent on techniques to make this complexity manageable. Two techniques in particular stand out for their effectiveness:</p>
<ol>
<li>Routine peer review of programs before they are deployed.</li>
<li>Testing.</li>
</ol>
<p>Testing, by which we implicitly mean automated testing, is the practice of writing small programs that check that the code under test (the production code) behaves as expected for certain inputs, which are usually either carefully chosen to exercise certain features or randomized to ensure broad coverage.</p>
<p>[p301]</p>
<p>Go's approach to testing is rather low-tech in. It relies on one command, <code>go test</code>, and a set of conventions for writing test functions that <code>go test</code> can run. The comparatively lightweight mechanism is effective for pure testing, and it extends naturally to benchmarks and systematic examples for documentation.</p>
<p>In practice, writing test code is not much different from writing the original program itself.  We write short functions that focus on one part of the task. We have to be careful of boundary conditions, think about data structures, and reason about what results a computation should produce from suitable inputs. But this is the same process as writing ordinary Go code.</p>
<h3 id="the-go-test-tool">The <code>go test</code> Tool<a class="headerlink" href="#the-go-test-tool" title="Permanent link">&para;</a></h3>
<p>The <a href="https://golang.org/cmd/go/#hdr-Description_of_testing_flags"><code>go test</code></a> subcommand is a test driver for Go packages that are organized according to certain conventions. In a package directory, files whose names end with <code>_test.go</code> are not part of the package ordinarily built by <code>go build</code> but are a part of it when built by <code>go test</code>.</p>
<p>Within <code>*_test.go</code> files, three kinds of functions are treated specially: tests, benchmarks, and
examples.</p>
<ul>
<li>A <em>test function</em> is a function whose name begins with <code>Test</code>. It exercises some program logic for correct behavior; <code>go test</code> calls the test function and reports the result, which is either <code>PASS</code> or <code>FAIL</code>.</li>
<li>A <em>benchmark function</em> has a name beginning with <code>Benchmark</code> and measures the performance of some operation; <code>go test</code> reports the mean execution time of the operation.</li>
<li>A <em>example function</em>, whose name starts with <code>Example</code>, provides machine-checked documentation.</li>
</ul>
<p>The <code>go test</code> tool scans the <code>*_test.go</code> files for these special functions, generates a temporary <code>main</code> package that calls them all in the proper way, builds and runs it, reports the results, and then cleans up.</p>
<h3 id="test-functions">Test Functions<a class="headerlink" href="#test-functions" title="Permanent link">&para;</a></h3>
<p>Each test file must import the testing package. Test functions have the following signature:</p>
<div class="codehilite"><pre><span class="kd">func</span> <span class="nx">TestName</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>


<p>Test function names must begin with <code>Test</code>; the optional suffix <code>Name</code> must begin with a capital letter:</p>
<div class="codehilite"><pre><span class="kd">func</span> <span class="nx">TestSin</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
<span class="kd">func</span> <span class="nx">TestCos</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
<span class="kd">func</span> <span class="nx">TestLog</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
</pre></div>


<p>The <code>t</code> parameter provides methods for reporting test failures and logging additional information.</p>
<p>For example, the package <a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/word1/word.go">gopl.io/ch11/word1</a> contains a single function <code>IsPalindrome</code> that reports whether a string reads the same forward and backward.</p>
<p><small><a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/word1/word.go">gopl.io/ch11/word1/word.go</a></small></p>
<div class="codehilite"><pre><span class="c1">// Package word provides utilities for word games.</span>
<span class="kn">package</span> <span class="nx">word</span>

<span class="c1">// IsPalindrome reports whether s reads the same forward and backward.</span>
<span class="c1">// (Our first attempt.)</span>
<span class="kd">func</span> <span class="nx">IsPalindrome</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>


<p>In the same directory, the file <a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/word1/word_test.go">word_test.go</a> contains two test functions named <code>TestPalindrome</code> and <code>TestNonPalindrome</code>. Each checks that <code>IsPalindrome</code> gives the right answer for a single input and reports failures using <code>t.Error</code>:</p>
<div class="codehilite"><pre><span class="kn">package</span> <span class="nx">word</span>

<span class="kn">import</span> <span class="s">&quot;testing&quot;</span>

<span class="kd">func</span> <span class="nx">TestPalindrome</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">IsPalindrome</span><span class="p">(</span><span class="s">&quot;detartrated&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">`IsPalindrome(&quot;detartrated&quot;) = false`</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">IsPalindrome</span><span class="p">(</span><span class="s">&quot;kayak&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">`IsPalindrome(&quot;kayak&quot;) = false`</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">TestNonPalindrome</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">IsPalindrome</span><span class="p">(</span><span class="s">&quot;palindrome&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">`IsPalindrome(&quot;palindrome&quot;) = true`</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>A <code>go test</code> (or <code>go build</code>) command with no package arguments operates on the package in the current directory. We can build and run the tests with the following command.</p>
<div class="codehilite"><pre><span class="gp">$</span> <span class="nb">cd</span> $GOPATH/src/gopl.io/ch11/word1
<span class="gp">$</span> go <span class="nb">test</span>
<span class="go">ok</span>
<span class="go">gopl.io/ch11/word1 0.008s</span>
</pre></div>


<p>However, <code>IsPalindrome</code> cannot recognize some other palindrome strings such as "été" or "A man, a plan, a canal: Panama".</p>
<div class="codehilite"><pre><span class="kd">func</span> <span class="nx">TestFrenchPalindrome</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">IsPalindrome</span><span class="p">(</span><span class="s">&quot;été&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">`IsPalindrome(&quot;été&quot;) = false`</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">TestCanalPalindrome</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">input</span> <span class="o">:=</span> <span class="s">&quot;A man, a plan, a canal: Panama&quot;</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">IsPalindrome</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">`IsPalindrome(%q) = false`</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>To avoid writing the long input string twice, we use <code>Errorf</code>, which provides formatting like <code>Printf</code>.</p>
<p>When the two new tests have been added, the <code>go test</code> command fails with informative error messages.</p>
<div class="codehilite"><pre><span class="gp">$</span> go <span class="nb">test</span>
<span class="go">--- FAIL: TestFrenchPalindrome (0.00s)</span>
<span class="go">word_test.go:28: IsPalindrome(&quot;été&quot;) = false</span>
<span class="go">--- FAIL: TestCanalPalindrome (0.00s)</span>
<span class="go">word_test.go:35: IsPalindrome(&quot;A man, a plan, a canal: Panama&quot;) = false</span>
<span class="go">FAIL</span>
<span class="go">FAIL</span>
</pre></div>


<p>As a bonus, running <code>go test</code> is usually quicker than manually going through the steps described in the bug report, allowing us to iterate more rapidly. If the test suite contains many slow tests, we may make even faster progress if we're selective about which ones we run.</p>
<p>The <code>-v</code> flag prints the name and execution time of each test in the package:</p>
<div class="codehilite"><pre><span class="gp">$</span> go <span class="nb">test</span> -v
<span class="go">=== RUN TestPalindrome</span>
<span class="go">--- PASS: TestPalindrome (0.00s)</span>
<span class="go">=== RUN TestNonPalindrome</span>
<span class="go">--- PASS: TestNonPalindrome (0.00s)</span>
<span class="go">=== RUN TestFrenchPalindrome</span>
<span class="go">--- FAIL: TestFrenchPalindrome (0.00s)</span>
<span class="go">word_test.go:28: IsPalindrome(&quot;été&quot;) = false</span>
<span class="go">=== RUN TestCanalPalindrome</span>
<span class="go">--- FAIL: TestCanalPalindrome (0.00s)</span>
<span class="go">word_test.go:35: IsPalindrome(&quot;A man, a plan, a canal: Panama&quot;) = false</span>
<span class="go">FAIL</span>
<span class="go">exit status 1</span>
<span class="go">FAIL gopl.io/ch11/word1 0.017s</span>
</pre></div>


<p>The <code>-run</code> flag, whose argument is a regular expression, causes <code>go test</code> to run only those tests whose function name matches the pattern:</p>
<div class="codehilite"><pre><span class="gp">$</span> go <span class="nb">test</span> -v -run<span class="o">=</span><span class="s2">&quot;French|Canal&quot;</span>
<span class="go">=== RUN TestFrenchPalindrome</span>
<span class="go">--- FAIL: TestFrenchPalindrome (0.00s)</span>
<span class="go">word_test.go:28: IsPalindrome(&quot;été&quot;) = false</span>
<span class="go">=== RUN TestCanalPalindrome</span>
<span class="go">--- FAIL: TestCanalPalindrome (0.00s)</span>
<span class="go">word_test.go:35: IsPalindrome(&quot;A man, a plan, a canal: Panama&quot;) = false</span>
<span class="go">FAIL</span>
<span class="go">exit status 1</span>
<span class="go">FAIL</span>
</pre></div>


<p>Once we've gotten the selected tests to pass, we should invoke <code>go test</code> with no flags to run the entire test suite one last time before we commit the change.</p>
<p>A quick investigation reveals the cause of the first bug to be <code>IsPalindrome</code>'s use of byte sequences, not rune sequences, so that non-ASCII characters such as the é in "<code>été</code>" confuse it. The second bug arises from not ignoring spaces, punctuation, and letter case.</p>
<p>Then we rewrite the function more carefully:</p>
<p><small><a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/word2/word.go">gopl.io/ch11/word2/word.go</a></small></p>
<div class="codehilite"><pre><span class="go">// Package word provides utilities for word games.</span>
<span class="go">package word</span>

<span class="go">import &quot;unicode&quot;</span>

<span class="go">// IsPalindrome reports whether s reads the same forward and backward.</span>
<span class="go">// Letter case is ignored, as are non-letters.</span>
<span class="go">func IsPalindrome(s string) bool {</span>
<span class="go">    var letters []rune</span>
<span class="go">    for _, r := range s {</span>
<span class="go">        if unicode.IsLetter(r) {</span>
<span class="go">            letters = append(letters, unicode.ToLower(r))</span>
<span class="go">        }</span>
<span class="go">    }</span>
<span class="go">    for i := range letters {</span>
<span class="go">        if letters[i] != letters[len(letters)-1-i] {</span>
<span class="go">            return false</span>
<span class="go">        }</span>
<span class="go">    }</span>
<span class="go">    return true</span>
<span class="go">}</span>
</pre></div>


<p>We also write a more comprehensive set of test cases that combines all the previous ones and a number of new ones into a table.</p>
<div class="codehilite"><pre><span class="kd">func</span> <span class="nx">TestIsPalindrome</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tests</span> <span class="p">=</span> <span class="p">[]</span><span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">input</span> <span class="kt">string</span>
        <span class="nx">want</span>  <span class="kt">bool</span>
    <span class="p">}{</span>
        <span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;aa&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;ab&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;kayak&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;detartrated&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;A man, a plan, a canal: Panama&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;Evil I did dwell; lewd did I live.&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;Able was I ere I saw Elba&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;été&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;Et se resservir, ivresse reste.&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;palindrome&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="c1">// non-palindrome</span>
        <span class="p">{</span><span class="s">&quot;desserts&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span>   <span class="c1">// semi-palindrome</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">test</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tests</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">got</span> <span class="o">:=</span> <span class="nx">IsPalindrome</span><span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">input</span><span class="p">);</span> <span class="nx">got</span> <span class="o">!=</span> <span class="nx">test</span><span class="p">.</span><span class="nx">want</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;IsPalindrome(%q) = %v&quot;</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="nx">got</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>The new tests pass:</p>
<div class="codehilite"><pre><span class="gp">$</span> go <span class="nb">test</span> gopl.io/ch11/word2
<span class="go">ok gopl.io/ch11/word2 0.015s</span>
</pre></div>


<p>This style of <a href="https://en.wikipedia.org/wiki/Keyword-driven_testing">table-driven testing</a> (see also <a href="https://github.com/golang/go/wiki/TableDrivenTests">TableDrivenTests</a>) is very common in Go. It is straightforward to add new table entries as needed.</p>
<p>The output of a failing test does not include the entire stack trace at the moment of the call to <code>t.Errorf</code>. Nor does <code>t.Errorf</code> cause a panic or stop the execution of the test, unlike assertion failures in many test frameworks for other languages. Tests are independent of each other. If an early entry in the table causes the test to fail, later table entries will still be checked, and thus we may learn about multiple failures during a single run.</p>
<p>When we really must stop a test function, perhaps because some initialization code failed or to prevent a failure already reported from causing a confusing cascade of others, we use <code>t.Fatal</code> or <code>t.Fatalf</code>. <u>These must be called from the same goroutine as the <code>Test</code> function, not from another one created during the test.</u></p>
<p>Test failure messages are usually of the form "<code>f(x) = y, want z</code>", where <code>f(x)</code> explains the attempted operation and its input, <code>y</code> is the actual result, and <code>z</code> the expected result:</p>
<ul>
<li>Where convenient, actual Go syntax is used for the <code>f(x)</code> part.</li>
<li>Displaying <code>x</code> is particularly important in a table-driven test, since a given assertion is executed many times with different values.</li>
<li>Avoid boilerplate and redundant information. When testing a boolean function such as <code>IsPalindrome</code>, omit the <code>want z</code> part since it adds no information. If <code>x</code>, <code>y</code>, or <code>z</code> is lengthy, print a concise summary of the relevant parts instead.</li>
<li>The author of a test should strive to help the programmer who must diagnose a test failure.</li>
</ul>
<h4 id="randomized-testing">Randomized Testing<a class="headerlink" href="#randomized-testing" title="Permanent link">&para;</a></h4>
<p>Table-driven tests are convenient for checking that a function works on inputs which are carefully selected to exercise interesting cases in the logic. Another approach, <a href="https://en.wikipedia.org/wiki/Random_testing"><em>randomized testing</em></a>, explores a broader range of inputs by constructing inputs at random.</p>
<p>How do we know what output to expect from our function, given a random input? There are two strategies:</p>
<ol>
<li>Write an alternative implementation of the function that uses a less efficient but simpler and clearer algorithm, and check that both implementations give the same result.</li>
<li>Create input values according to a pattern so that we know what output to expect.</li>
</ol>
<p>The example below uses the second approach: the <code>randomPalindrome</code> function generates words that are known to be palindromes by construction.</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="s">&quot;math/rand&quot;</span>

<span class="c1">// randomPalindrome returns a palindrome whose length and contents</span>
<span class="c1">// are derived from the pseudo-random number generator rng.</span>
<span class="kd">func</span> <span class="nx">randomPalindrome</span><span class="p">(</span><span class="nx">rng</span> <span class="o">*</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Rand</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">n</span> <span class="o">:=</span> <span class="nx">rng</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="c1">// random length up to 24</span>
    <span class="nx">runes</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">rune</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="p">(</span><span class="nx">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="nx">r</span> <span class="o">:=</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">rng</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">))</span> <span class="c1">// random rune up to &#39;\u0999&#39;</span>
      <span class="nx">runes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">r</span>
      <span class="nx">runes</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">r</span>
  <span class="p">}</span>
    <span class="k">return</span> <span class="nb">string</span><span class="p">(</span><span class="nx">runes</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">TestRandomPalindromes</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Initialize a pseudo-random number generator.</span>
    <span class="nx">seed</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UTC</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">()</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;Random seed: %d&quot;</span><span class="p">,</span> <span class="nx">seed</span><span class="p">)</span>
    <span class="nx">rng</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">NewSource</span><span class="p">(</span><span class="nx">seed</span><span class="p">))</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="nx">p</span> <span class="o">:=</span> <span class="nx">randomPalindrome</span><span class="p">(</span><span class="nx">rng</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">!</span><span class="nx">IsPalindrome</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;IsPalindrome(%q) = false&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Since randomized tests are nondeterministic, it is critical the failing test logs sufficient information to reproduce the failure. In the above example, the input <code>p</code> to <code>IsPalindrome</code> is all we need to know, but for functions that accept more complex inputs, it may be simpler to log the seed of the pseudo-random number generator (as we do above) than to dump the entire input data structure. With that seed value, we can easily modify the test to replay the failure deterministically.</p>
<p>By using the current time as a source of randomness, the test will explore novel inputs each time it is run, over the entire course of its lifetime. This is especially valuable if your project uses an automated system to run all its tests periodically.</p>
<h4 id="testing-a-command">Testing a Command<a class="headerlink" href="#testing-a-command" title="Permanent link">&para;</a></h4>
<p>The <code>go test</code> tool is useful for testing library packages. We can use it to test commands as well. A package named <code>main</code> ordinarily produces an executable program, but it can also be imported as a library.</p>
<p>Consider the <a href="https://github.com/shichao-an/gopl.io/blob/master/ch2/echo4/main.go"><code>echo</code></a> program of <a href="../ch2/#pointers">Section 2.3.2</a>. The program is split into two functions: <code>echo</code> does the real work, while <code>main</code> parses and reads the flag values and reports any errors returned by <code>echo</code>.</p>
<p><small><a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/echo/echo.go">gopl.io/ch11/echo/echo.go</a></small></p>
<div class="codehilite"><pre><span class="c1">// Echo prints its command-line arguments.</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;flag&quot;</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;io&quot;</span>
    <span class="s">&quot;os&quot;</span>
    <span class="s">&quot;strings&quot;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="p">(</span>
    <span class="nx">n</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Bool</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&quot;omit trailing newline&quot;</span><span class="p">)</span>
    <span class="nx">s</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;separator&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">out</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span> <span class="c1">// modified during testing</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">echo</span><span class="p">(!</span><span class="o">*</span><span class="nx">n</span><span class="p">,</span> <span class="o">*</span><span class="nx">s</span><span class="p">,</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Args</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&quot;echo: %v\n&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">echo</span><span class="p">(</span><span class="nx">newline</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">sep</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprint</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">sep</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">newline</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintln</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>


<p>We will write a test:</p>
<ul>
<li>It calls <code>echo</code> with a variety of arguments and flag settings and check that it prints the correct output in each case, so we've added parameters to <code>echo</code> to reduce its dependence on global variables.</li>
<li>We've also introduced another global variable, <code>out</code>, the <code>io.Writer</code> to which the result will be written. By having <code>echo</code> write through this variable, not directly to <code>os.Stdout</code>, the tests can substitute a different <code>Writer</code> implementation that records what was written for later inspection.</li>
</ul>
<p>The test is in file <a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/echo/echo_test.go">echo_test.go</a>:</p>
<div class="codehilite"><pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;bytes&quot;</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;testing&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">TestEcho</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tests</span> <span class="p">=</span> <span class="p">[]</span><span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">newline</span> <span class="kt">bool</span>
        <span class="nx">sep</span>     <span class="kt">string</span>
        <span class="nx">args</span>    <span class="p">[]</span><span class="kt">string</span>
        <span class="nx">want</span>    <span class="kt">string</span>
    <span class="p">}{</span>
        <span class="p">{</span><span class="kc">true</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span> <span class="s">&quot;\n&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="kc">false</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span> <span class="s">&quot;&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="kc">true</span><span class="p">,</span> <span class="s">&quot;\t&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;one&quot;</span><span class="p">,</span> <span class="s">&quot;two&quot;</span><span class="p">,</span> <span class="s">&quot;three&quot;</span><span class="p">},</span> <span class="s">&quot;one\ttwo\tthree\n&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="kc">true</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">},</span> <span class="s">&quot;a,b,c\n&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="kc">false</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">,</span> <span class="s">&quot;3&quot;</span><span class="p">},</span> <span class="s">&quot;1:2:3&quot;</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">test</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tests</span> <span class="p">{</span>
        <span class="nx">descr</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;echo(%v, %q, %q)&quot;</span><span class="p">,</span>
            <span class="nx">test</span><span class="p">.</span><span class="nx">newline</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">sep</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">args</span><span class="p">)</span>

        <span class="nx">out</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span> <span class="c1">// captured output</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">echo</span><span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">newline</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">sep</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;%s failed: %v&quot;</span><span class="p">,</span> <span class="nx">descr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="nx">got</span> <span class="o">:=</span> <span class="nx">out</span><span class="p">.(</span><span class="o">*</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">).</span><span class="nx">String</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">got</span> <span class="o">!=</span> <span class="nx">test</span><span class="p">.</span><span class="nx">want</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;%s = %q, want %q&quot;</span><span class="p">,</span> <span class="nx">descr</span><span class="p">,</span> <span class="nx">got</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">want</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Notice that the test code is in the same package as the production code. <u>Although the package name is <code>main</code> and it defines a <code>main</code> function, during testing this package acts as a library that exposes the function <code>TestEcho</code> to the test driver; its <code>main</code> function is ignored. By organizing the test as a table, we can easily add new test cases.</u> Let's see what happens when the test fails, by adding this line to the table:</p>
<div class="codehilite"><pre><span class="p">{</span><span class="kc">true</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">},</span> <span class="s">&quot;a b c\n&quot;</span><span class="p">},</span> <span class="c1">// NOTE: wrong expectation!</span>
</pre></div>


<p><code>go test</code> prints:</p>
<div class="codehilite"><pre><span class="gp">$</span> go <span class="nb">test</span> gopl.io/ch11/echo
<span class="go">--- FAIL: TestEcho (0.00s)</span>
<span class="go">echo_test.go:31: echo(true, &quot;,&quot;, [&quot;a&quot; &quot;b&quot; &quot;c&quot;]) = &quot;a,b,c&quot;, want &quot;a b c\n&quot;</span>
<span class="go">FAIL</span>
<span class="go">FAIL gopl.io/ch11/echo 0.006s</span>
</pre></div>


<p>The error message describes the attempted operation (using Go-like syntax), the actual behavior, and the expected behavior, in that order. With an informative error message such as this, you may have a pretty good idea about the root cause before you've even located the source code of the test.</p>
<p>It's important that code being tested not call <code>log.Fatal</code> or <code>os.Exit</code>, since these will stop the process in its tracks; calling these functions should be regarded as the exclusive right of <code>main</code>. If something totally unexpected happens and a function panics, the test driver will recover, though the test will be considered a failure. Expected errors such as those resulting from bad user input, missing files, or improper configuration should be reported by returning a non-nil error value. However, our echo example is so simple that it will never return a non-nil error.</p>
            </div>
        </div>

        <footer class="col-md-12">
            
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../custom.js"></script>
    </body>
</html>